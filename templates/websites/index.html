{% extends 'base.html' %}

<!-- prettier-ignore -->
{% block title %}
Monitoring Web ITK - Daftar Website
{% endblock %}

<!-- prettier-ignore -->
{% block content %}

<!-- Page Heading -->

<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">Daftar Website</h1>
</div>
<!-- <p class="mb-4">
              DataTables is a third party plugin that is used to generate the demo table below. For more information about DataTables, please visit the <a target="_blank" href="https://datatables.net">official DataTables documentation</a>.
            </p> -->

<div class="row">
  <div class="col">
    {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %} {% for category, message in messages %}
    <div class="mb-3 alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    </div>

    {% endfor %} {% endif %} {% endwith %}
  </div>
</div>

<!-- DataTales Example -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <div class="row">
      <div class="col">
        <h6 class="m-0 py-3 font-weight-bold text-primary">Daftar Website</h6>
      </div>
      <div class="d-flex col justify-content-end">
        <button type="button" class="btn btn-primary btn" data-toggle="modal" data-target="#addModal">Tambah Website</button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
        <thead>
          <tr>
            <th>#</th>
            <th>Kategori</th>
            <th>Unit</th>
            <th>URL</th>
            <th>Halaman</th>
            <th style="width: 12%">Aksi</th>
          </tr>
        </thead>
        <tfoot>
          <tr>
            <th>#</th>
            <th>Kategori</th>
            <th>Unit</th>
            <th>URL</th>
            <th>Halaman</th>
            <th>Aksi</th>
          </tr>
        </tfoot>
        <tbody>
          {% for web in websites %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ web.slug_web }}</td>
            <td>{{ web.nama_web }}</td>
            <td>{{ web.link_web }}</td>
            <td>
              <ul class="list-group list-group-flush py-0">
                {% for page in web.pages %}
                <li class="list-group-item" style="padding: 0.25rem 1rem; font-size: 0.875rem">{{ page.halaman_web }}</li>
                {% endfor %}
              </ul>
            </td>
            <td class="p-0 text-center align-middle">
              <!-- prettier-ignore -->
              {% set pages_list = [] %} 
                          {% for page in web.pages %}
                            {% set _ = pages_list.append({"halaman_web": page.halaman_web}) %} 
                          {% endfor %}

              <!-- <pre>{{ pages_list | tojson }}</pre> -->
              <!-- prettier-ignore -->
              <button type="button" class="btn btn-primary btn-sm open-edit-modal" data-id="{{ web.id_web }}" data-nama="{{ web.nama_web }}" data-link="{{ web.link_web }}" data-pages='{{ pages_list | tojson | safe }}'><i class="fas fa-pen fa-sm text-white-50"></i>
                            Edit
                          </button>
              <button type="button" class="btn btn-sm btn-danger" data-toggle="modal" data-target="#deleteModal" data-id="{{ web.id_web }}" data-name="{{ web.nama_web }}"><i class="fas fa-trash fa-sm text-white-50"></i> Hapus</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Logout Modal-->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
      <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <a class="btn btn-primary" href="login.html">Logout</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal Add-->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Tambah Website</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <form method="POST" action="{{ url_for('websites.add_website') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNamaWeb" class="form-label">Unit</label>
            <input type="text" class="form-control" name="nama_web" id="inputNamaWeb" aria-describedby="namaWebHelp" placeholder="Unit Website" required />
          </div>
          <div class="mb-3">
            <label for="inputUrlWeb" class="form-label">URL</label>
            <input type="url" class="form-control" name="link_web" id="inputUrlWeb" placeholder="https://itk.ac.id" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Pages</label>
            <div id="pages-container">
              <div class="input-group mb-2">
                <input type="text" name="halaman_web[]" class="form-control" placeholder="/login" required />
                <div class="input-group-append">
                  <button class="btn btn-danger remove-page" type="button"><i class="fas fa-trash fa-sm text-white-50"></i></button>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-secondary" id="add-page">+ Add Page</button>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Hapus-->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModal">Konfirmasi Penghapusan</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus <strong id="delete-item-name">unit ini</strong>?</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
        <a id="confirm-delete-btn" class="btn btn-danger" href="#">Hapus</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal Edit-->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Website</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <form method="POST" id="editForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <div class="modal-body">
          <div class="mb-3">
            <label for="editNamaWeb" class="form-label">Unit</label>
            <input type="text" class="form-control" name="nama_web" id="editNamaWeb" aria-describedby="namaWebHelp" placeholder="Unit Website" required />
          </div>
          <div class="mb-3">
            <label for="editUrlWeb" class="form-label">URL</label>
            <input type="url" class="form-control" name="link_web" id="editUrlWeb" placeholder="https://itk.ac.id" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Pages</label>
            <div class="pages-container" id="edit-pages-container"></div>
            <button type="button" class="btn btn-sm btn-secondary add-page-btn">+ Add Page</button>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  $(document).ready(function () {
    setTimeout(function () {
      $(".alert").alert("close");
    }, 2000);
  });
</script>

<!-- Script Delete -->

<script>
  $("#deleteModal").on("show.bs.modal", function (event) {
    const button = $(event.relatedTarget); // Button that triggered the modal
    const id = button.data("id");
    const name = button.data("name");

    const modal = $(this);
    modal.find("#delete-item-name").text(name);
    modal.find("#confirm-delete-btn").attr("href", `/websites/delete/${id}`);
  });
</script>

<!-- Script Add -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const addContainer = document.getElementById("pages-container");

    function updateDeleteButtonsAdd() {
      const groups = addContainer.querySelectorAll(".input-group");
      const buttons = addContainer.querySelectorAll(".remove-page");

      buttons.forEach((btn) => {
        btn.disabled = groups.length <= 1;
      });
    }

    document.getElementById("add-page").addEventListener("click", function () {
      const container = document.getElementById("pages-container");
      const group = document.createElement("div");
      group.className = "input-group mb-2";
      group.innerHTML = `
            <input type="text" name="halaman_web[]" class="form-control" placeholder="/login" required />
            <div class="input-group-append">
              <button class="btn btn-danger remove-page" type="button"><i class="fas fa-trash fa-sm text-white-50"></i></button>
            </div>
          `;

      container.appendChild(group);
      updateDeleteButtonsAdd();
    });

    // Handle remove page
    document.addEventListener("click", function (e) {
      if (e.target.closest(".remove-page")) {
        e.target.closest(".input-group").remove();
        updateDeleteButtonsAdd();
      }
    });

    updateDeleteButtonsAdd();
  });
</script>

<!-- Script Edit -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Edit modal script loaded");
    const editPagesContainer = document.getElementById("edit-pages-container");

    function updateDeleteButtons() {
      const total = editPagesContainer.querySelectorAll(".input-group").length;
      const buttons = editPagesContainer.querySelectorAll(".remove-page");

      buttons.forEach((btn) => {
        btn.disabled = total <= 1;
      });
    }

    document.querySelectorAll(".open-edit-modal").forEach((button) => {
      button.addEventListener("click", function () {
        const id = this.dataset.id;
        const nama = this.dataset.nama;
        const link = this.dataset.link;
        const pages = JSON.parse(this.dataset.pages);

        // Update form action
        const form = document.getElementById("editForm");
        form.action = `/websites/edit/${id}`;

        // Set input values
        document.getElementById("editNamaWeb").value = nama;
        document.getElementById("editUrlWeb").value = link;

        // Populate pages
        const container = document.getElementById("edit-pages-container");
        container.innerHTML = "";

        pages.forEach((page) => {
          const div = document.createElement("div");
          div.className = "input-group mb-2";
          div.innerHTML = `
          <input type="text" name="halaman_web[]" class="form-control" value="${page.halaman_web}" required />
          <div class="input-group-append">
            <button class="btn btn-danger remove-page" type="button"><i class="fas fa-trash fa-sm text-white-50"></i></button>
          </div>
        `;
          container.appendChild(div);
        });

        updateDeleteButtons();

        // Open the modal
        $("#editModal").modal("show");
      });
    });

    // Handle remove page
    document.addEventListener("click", function (e) {
      const removeBtn = e.target.closest(".remove-page");
      if (removeBtn) {
        removeBtn.closest(".input-group").remove();
        updateDeleteButtons();
      }
    });

    // Handle add new page
    document.querySelector("#editModal .add-page-btn").addEventListener("click", function () {
      const container = document.getElementById("edit-pages-container");
      const div = document.createElement("div");
      div.className = "input-group mb-2";
      div.innerHTML = `
      <input type="text" name="halaman_web[]" class="form-control" placeholder="/new-page" required />
      <div class="input-group-append">
        <button class="btn btn-danger remove-page" type="button"><i class="fas fa-trash fa-sm text-white-50"></i></button>
      </div>
    `;
      container.appendChild(div);
      updateDeleteButtons();
    });
  });
</script>

{% endblock %}
